<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Satellite</title>
    <link rel="shortcut icon" href="https://www.pngall.com/wp-content/uploads/2016/04/Satellite-Download-PNG.png">
    <script src="https://unpkg.com/leaflet@1.0.2/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.2/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        var map, osm, esri, terreno;
        var controlCapas;
        var controlEscala;
    
        function init() {
            userLLA=[]
            userLLA.push(["{{userlat}}", "{{userlong}}"]);
            long=[{% for item in longs %}
                "{{ item }}",
                {% endfor %}]

            lat=[{% for item in lats %}
                "{{ item }}",
                {% endfor %}]
                satPos1=[];
                satPos2=[];
                longProv=0;
                newSat=0;
                for(var j=1; j<long.length; j++) {
                    if  ((longProv>0) && (long[j]<0)){
                        newSat=1;
                    }
                    if (newSat==1){
                        satPos2.push([lat[j], long[j]]);
                    }
                    if (newSat==0){
                        satPos1.push([lat[j], long[j]]);
                    }
                    longProv=long[j];
                }

            Xvis=[{% for item in xvis %}
                "{{ item }}",
                {% endfor %}]

            Yvis=[{% for item in yvis %}
                "{{ item }}",
                {% endfor %}]
                visPos=[];
                for(var j=0; j<Xvis.length; j++) {
                    visPos.push([Yvis[j],Xvis[j]]);
                }

            var satIcon = L.icon({iconUrl: 'https://upload.wikimedia.org/wikipedia/commons/thumb/2/27/FP_Satellite_icon.svg/1200px-FP_Satellite_icon.svg.png',
                iconSize: [40, 40], // size of the icon
            });
            var southWest = L.latLng(-89.98155760646617, -180),
            northEast = L.latLng(89.99346179538875, 180);
            var bounds = L.latLngBounds(southWest, northEast);
            map = L.map('map',{maxBounds: bounds,
                maxBoundsViscosity: 1.0}).setView([20, 1.8382], 2);
                /*Legend specific*/
                var legend = L.control({ position: "topleft" });
                
                legend.onAdd = function(map) {
                    var div = L.DomUtil.create("div", "legend");
                    div.innerHTML += '<i style="background: red"></i><span>Satellite Trajectory</span><br>';
                    div.innerHTML += '<i style="background: dodgerblue"></i><span>User Visibility Area</span><br>';
                    div.innerHTML += '<i style="background: black"></i><span>Satellite Position at plot time</span><br>';
                    return div;
                };
                legend.addTo(map);

            

    
            esri = L.tileLayer(
                'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                maxZoom: 6,
                minZoom: 2,
                attribution: 'Tiles Â© Esri',
                noWrap: true,              //this is the crucial line!
                bounds: [
                    [-90, -180],
                    [90, 180]]
            });
    
            osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 6,
                minZoom: 2,
                attribution: 'OSM',
                noWrap: true,              //this is the crucial line!
                bounds: [
                    [-90, -180],
                    [90, 180]]
            }).addTo(map);
    
            var baseMaps = {
                "Satellite": esri,
                "Default": osm
            };

            var latUser = parseFloat(userLLA[0][0]).toFixed(2);
            var longUser = parseFloat(userLLA[0][1]).toFixed(2);
            var latSat=parseFloat(satPos1[0][0]).toFixed(2);
            var longSat= parseFloat(satPos1[0][1]).toFixed(2);
            var markerUser = L.marker(userLLA[0]).bindPopup("User position: Lat:"+latUser+" Long:"+longUser).addTo(map);
            var markerSat = L.marker(satPos1[0],{icon: satIcon}).bindPopup("Sat position: Lat:"+latSat+" Long:"+longSat).addTo(map);
            var polygon = L.polygon(visPos).addTo(map);
            var polyline = L.polyline(satPos1, {color: 'red'}).addTo(map);
            var polyline2 = L.polyline(satPos2, {color: 'red'}).addTo(map);

    
            controlCapas = L.control.layers(baseMaps);
            controlCapas.addTo(map);
    
            controlEscala = L.control.scale();
            controlEscala.addTo(map);   
        }
    </script>
    <style>
    body {
        background-color:#383A3F;
    }
    canvas {
        background: blue;
    }
    p {
        color:white;
        font-size:12pt;
        font-family:arial,helvetica;
        padding-left: 20px;
      }
    h1 {
        color:white;
        font-size:36pt;
        font-family:verdana,arial;
        text-decoration:underline;
        text-align:center;
        margin-block-start: 0.3em;
        margin-block-end: 0.3em;
      }
    .btn {
        display: block;
        background:blue;
        font-family:verdana,arial;
        text-align: center;
        width: 100%;
        height: 60%;
        color: white;
        border-radius: 5px;
        padding: 10px 5px;
        box-shadow: rgba(0,0,0,0.9);
        transition: all 200ms ease-in-out;
        text-decoration: none;
      }
    .grid-container {
        display: grid;
        grid-template-columns: auto auto auto auto;
        grid-gap: 10px;
        padding: 10px;
    }
    .item1 {
        grid-row: 1 / span 2;
    }
    #map { 
        width: 68%;
        height: 850px;
        box-shadow: 5px 5px 5px #888;
        margin: 0 auto;
        display: block;
    }
    .legend {
        padding: 6px 8px;
        font: 14px Arial, Helvetica, sans-serif;
        background: white;
        background: rgba(255, 255, 255, 0.3);
        line-height: 24px;
        color: black;
    }
    .legend i {
        width: 18px;
        height: 18px;
        float: left;
        margin: 0 8px 0 0;
        opacity: 0.7;
    }
    </style>
</head>
<body onLoad="init()">
    <h1>Satellite</h1>
    <div class="grid-container">
        <div class="item1">
            {% for entry in entries %}
            <p>{{ entry }}</p>
            {% endfor %}
            <p id="visText">The satellite will not be visible during their next orbit!</p> 
        </div>
        <div class="item2" id="button" hidden>
            <a href="{{number}}/doppler" class="btn">View Visibility Analysis</a>   
        </div>
    </div>
    <!--<canvas id="myChart"></canvas>
        <script>
            const pointImage=new Image(50,50)
            pointImage.src= 'https://upload.wikimedia.org/wikipedia/commons/thumb/2/27/FP_Satellite_icon.svg/1200px-FP_Satellite_icon.svg.png'
            //https://cdn-icons-png.flaticon.com/512/1679/1679957.png
            
            userLLA=[]
            userLLA.push({x: "{{userlong}}",y: "{{userlat}}"});
            long=[{% for item in longs %}
                "{{ item }}",
                {% endfor %}]

            lat=[{% for item in lats %}
                "{{ item }}",
                {% endfor %}]
                satPos=[];
                for(var j=1; j<long.length; j++) {
                    satPos.push({x: long[j],y: lat[j]});
                }

            wordlLat=[{% for item in worldLa %}
                "{{ item }}",
                {% endfor %}]

            worldLong=[{% for item in worldLo %}
                "{{ item }}",
                {% endfor %}]
                worldPos=[];
                for(var j=0; j<wordlLat.length; j++) {
                    worldPos.push({x: worldLong[j],y: wordlLat[j]});
                }

            Xvis=[{% for item in xvis %}
                "{{ item }}",
                {% endfor %}]

            Yvis=[{% for item in yvis %}
                "{{ item }}",
                {% endfor %}]
                visPos=[];
                for(var j=0; j<wordlLat.length; j++) {
                    visPos.push({x: Xvis[j],y: Yvis[j]});
                }
            const data = {
              datasets: [     
            {
                label: 'User Visibility',
                backgroundColor: 'white',
                borderColor: 'white',
                data: visPos,
                pointRadius:2,
            },        
            {
                label: 'Actual Position',
                backgroundColor: 'black',
                borderColor: 'black',
                data: [{x: long[0],y: lat[0]}],
                pointRadius: 7,
                pointStyle: pointImage
            },
            {
                label: 'Sat Position',
                backgroundColor: 'rgb(250, 32, 32)',
                borderColor: 'rgb(250, 32, 32)',
                data: satPos,
                pointRadius: 2,
              },
              {
                label: 'User Position',
                backgroundColor: 'yellow',
                borderColor: 'yellow',
                data: userLLA,
                pointRadius: 8,
                pointStyle: "rectRot"
              },
              {
                label: 'World',
                backgroundColor: 'rgb(0, 225, 0)',
                borderColor: 'rgb(0, 225, 0)',
                data: worldPos,
                pointRadius: 2,
              }]
            };
          
            const config = {
              type: 'scatter',
              data: data,
              options: {
                plugins: {
                    legend: {
                        labels: {
                            filter: item => {return item.text != "World"},
                            color: "white",
                        }
                    },
                },
                events: [],
                scales: {
                    x: {
                            max : 180,    
                            min : -180,
                            ticks: { color: 'white'},
                            grid: {color: 'white'},
                            title: {text: 'Longitude',color: 'white', display: true, align: 'center', font: {size:15}},
                        },
                    y: {
                            max : 90,    
                            min : -90,
                            ticks: { color: 'white'},
                            grid: {color: 'white'},
                            title: {text: 'Latitude',color: 'white', display: true, align: 'center', font: {size:15}},
                }}
            }};
            const myChart = new Chart(document.getElementById('myChart'),config);
        </script>-->
    <div id="map">
    </div>
    <script>
          let element = document.getElementById("button");
          let text = document.getElementById('visText');
          vis="{{vis}}"
          console.log(vis)
      
          if (vis==1) {
            element.removeAttribute("hidden");
            text.hidden=true;
          }
      </script>
</body>
</html>